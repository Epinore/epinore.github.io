<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dual Battle Arena v2 - CPS & Reaction Duel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #2c3e50;
            transition: background-color 0.5s ease;
            color: white;
        }

        /* 游戏容器 */
        .game-container {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* 玩家区域 */
        .player-area {
            transition: width 0.1s ease-out, background-color 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* CPS模式样式 */
        .cps-mode #blue-area {
            background: linear-gradient(to right, #2980b9, #3498db);
        }

        .cps-mode #red-area {
            background: linear-gradient(to left, #c0392b, #e74c3c);
        }

        /* 反应模式样式 */
        .reaction-mode #blue-area,
        .reaction-mode #red-area {
            background-color: #3399ff;
        }

        #blue-area,
        #red-area {
            width: 50%;
        }

        /* 分界线 */
        .divider {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background-color: white;
            box-shadow: 0 0 10px white;
            z-index: 10;
            transition: left 0.1s ease-out;
        }

        /* 游戏信息区域 */
        .game-info {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 20;
            color: white;
        }

        /* 模式选择 */
        .mode-selector {
            margin-bottom: 20px;
        }

        .mode-button {
            padding: 10px 20px;
            font-size: 1.2em;
            margin: 0 10px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .mode-button.active {
            background-color: #2ecc71;
        }

        /* 计时器 */
        .counter {
            font-size: 5em;
            font-weight: bold;
            margin-bottom: 20px;
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s ease;
        }

        .counter.countdown {
            animation: countdown-pulse 1s ease-in-out;
        }

        @keyframes countdown-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* 说明文字 */
        .instruction {
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        /* 分数显示 */
        .scores {
            display: flex;
            justify-content: space-around;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        /* CPS显示 */
        .cps-display {
            display: flex;
            justify-content: space-around;
            font-size: 1.2em;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* 游戏时间显示 */
        .game-time {
            font-size: 1.2em;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* 开始按钮 */
        .start-button {
            padding: 15px 40px;
            font-size: 1.5em;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 0 10px;
        }

        .start-button:hover {
            background-color: #27ae60;
        }

        .start-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }

        /* 胜利者显示 */
        .winner-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            display: none;
            z-index: 30;
            animation: victory-flash 0.5s ease-in-out infinite alternate;
        }

        @keyframes victory-flash {
            0% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* 按键提示 */
        .key-hint {
            position: absolute;
            bottom: 20px;
            font-size: 2em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        #blue-key {
            left: 20px;
        }

        #red-key {
            right: 20px;
        }

        .key-box {
            display: inline-block;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            border: 2px solid white;
            margin-left: 10px;
        }

        /* 震动动画 */
        .vibrate {
            animation: vibrate 0.1s ease-in-out;
        }

        @keyframes vibrate {
            0%, 100% { transform: translate(0); }
            25% { transform: translate(-2px, 2px); }
            50% { transform: translate(0); }
            75% { transform: translate(2px, -2px); }
        }

        /* 波纹效果 */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* 反应时间显示 */
        .reaction-time {
            display: flex;
            justify-content: space-around;
            font-size: 1.2em;
            margin-top: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* 彩带效果容器 */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
            overflow: hidden;
        }

        /* 反应模式小球 */
        .reaction-ball {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background-color: #ff0000;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            position: absolute;
        }

        .reaction-ball.green {
            background-color: #00ff66;
            transform: scale(1.1);
            box-shadow: 0 0 30px #00ff66, 0 0 60px #00ff66, inset 0 0 30px rgba(0, 255, 102, 0.5);
            animation: pulse-glow 0.5s ease-in-out;
        }

        @keyframes pulse-glow {
            0% { transform: scale(1); box-shadow: 0 0 0 rgba(0, 255, 102, 0.7); }
            50% { transform: scale(1.15); box-shadow: 0 0 40px rgba(0, 255, 102, 0.9), 0 0 80px rgba(0, 255, 102, 0.6); }
            100% { transform: scale(1.1); box-shadow: 0 0 30px rgba(0, 255, 102, 0.7), 0 0 60px rgba(0, 255, 102, 0.5); }
        }

        /* 区域闪烁光效 */
        .blue-flash {
            animation: blue-blink 0.3s ease-in-out infinite alternate;
        }

        .red-flash {
            animation: red-blink 0.3s ease-in-out infinite alternate;
        }

        @keyframes blue-blink {
            0% { background-color: #3399ff; }
            100% { background-color: #55aaff; box-shadow: inset 0 0 50px rgba(51, 153, 255, 0.5); }
        }

        @keyframes red-blink {
            0% { background-color: #3399ff; }
            100% { background-color: #ff9999; box-shadow: inset 0 0 50px rgba(255, 153, 153, 0.5); }
        }

        /* 按钮容器 */
        .button-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* 最终结果显示 */
        .final-stats {
            position: absolute;
            bottom: 100px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 1.2em;
            z-index: 25;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="cps-mode">
    <!-- 游戏容器 -->
    <div class="game-container">
        <div class="player-area" id="blue-area">
            <div class="key-hint" id="blue-key">蓝方: <span class="key-box">S</span></div>
            <div class="reaction-ball" id="blue-ball"></div>
        </div>
        <div class="divider"></div>
        <div class="player-area" id="red-area">
            <div class="key-hint" id="red-key">红方: <span class="key-box">L</span></div>
            <div class="reaction-ball" id="red-ball"></div>
        </div>
    </div>

    <!-- 游戏信息 -->
    <div class="game-info">
        <!-- 模式选择 -->
        <div class="mode-selector">
            <button class="mode-button active" id="cps-mode-btn">CPS Battle</button>
            <button class="mode-button" id="reaction-mode-btn">Reaction Duel</button>
        </div>
        
        <!-- 计时器 -->
        <div class="counter" id="counter">CPS 对战模式</div>
        
        <!-- 说明文字 -->
        <div class="instruction" id="instruction">点击下方按钮开始游戏</div>
        
        <!-- 分数显示 -->
        <div class="scores">
            <span id="blue-score">蓝方: 0</span>
            <span id="red-score">红方: 0</span>
        </div>
        
        <!-- CPS显示 -->
        <div class="cps-display">
            <span id="blue-cps">蓝方 CPS: 0.00</span>
            <span id="red-cps">红方 CPS: 0.00</span>
        </div>
        
        <!-- 游戏时间显示 -->
        <div class="game-time" id="game-time">游戏时间: 0.00s</div>
        
        <!-- 反应时间显示 -->
        <div class="reaction-time">
            <span id="blue-reaction">蓝方反应: -- ms</span>
            <span id="red-reaction">红方反应: -- ms</span>
        </div>
        
        <!-- 按钮容器 -->
        <div class="button-container">
            <button class="start-button" id="start-cps-button">Start CPS Battle</button>
            <button class="start-button" id="start-reaction-button">Start Reaction Test</button>
        </div>
    </div>

    <!-- 胜利者显示 -->
    <div class="winner-display" id="winner-display"></div>
    
    <!-- 最终统计 -->
    <div class="final-stats" id="final-stats"></div>
    
    <!-- 彩带效果容器 -->
    <div class="confetti-container" id="confetti-container"></div>

    <!-- 音效元素 -->
    <audio id="tick-sound" preload="auto"></audio>
    <audio id="go-sound" preload="auto"></audio>
    <audio id="click-blue" preload="auto"></audio>
    <audio id="click-red" preload="auto"></audio>
    <audio id="victory-sound" preload="auto"></audio>
    <audio id="green-sound" preload="auto"></audio>
    <audio id="buzz-sound" preload="auto"></audio>
    <audio id="waiting-sound" preload="auto"></audio>

    <script>
        // 游戏状态
        let gameState = {
            mode: 'cps', // 'cps' 或 'reaction'
            started: false,
            countingDown: false,
            blueScore: 0,
            redScore: 0,
            bluePressed: false,
            redPressed: false,
            gameStartTime: 0,
            gameEndTime: 0,
            countdown: 3,
            countdownInterval: null,
            gameTimeInterval: null,
            reactionWaitTime: 0,
            reactionTimer: null,
            waitingSoundInterval: null,
            greenTime: 0,
            blueReactionTime: 0,
            redReactionTime: 0,
            falseStart: false,
            falseStartPlayer: null,
            currentWinner: null
        };

        // DOM元素
        const body = document.body;
        const blueArea = document.getElementById('blue-area');
        const redArea = document.getElementById('red-area');
        const counter = document.getElementById('counter');
        const instruction = document.getElementById('instruction');
        const startCPSButton = document.getElementById('start-cps-button');
        const startReactionButton = document.getElementById('start-reaction-button');
        const winnerDisplay = document.getElementById('winner-display');
        const blueScoreEl = document.getElementById('blue-score');
        const redScoreEl = document.getElementById('red-score');
        const divider = document.querySelector('.divider');
        const cpsDisplay = document.querySelector('.cps-display');
        const blueCPS = document.getElementById('blue-cps');
        const redCPS = document.getElementById('red-cps');
        const gameTime = document.getElementById('game-time');
        const reactionTimeDisplay = document.querySelector('.reaction-time');
        const blueReaction = document.getElementById('blue-reaction');
        const redReaction = document.getElementById('red-reaction');
        const cpsModeButton = document.getElementById('cps-mode-btn');
        const reactionModeButton = document.getElementById('reaction-mode-btn');
        const confettiContainer = document.getElementById('confetti-container');
        const finalStats = document.getElementById('final-stats');
        const blueBall = document.getElementById('blue-ball');
        const redBall = document.getElementById('red-ball');
        
        // 音效元素
        const tickSound = document.getElementById('tick-sound');
        const goSound = document.getElementById('go-sound');
        const clickBlue = document.getElementById('click-blue');
        const clickRed = document.getElementById('click-red');
        const victorySound = document.getElementById('victory-sound');
        const greenSound = document.getElementById('green-sound');
        const buzzSound = document.getElementById('buzz-sound');
        const waitingSound = document.getElementById('waiting-sound');

        // 模式切换函数
        function switchMode(mode) {
            gameState.mode = mode;
            resetGame();
            
            // 更新按钮状态
            cpsModeButton.classList.toggle('active', mode === 'cps');
            reactionModeButton.classList.toggle('active', mode === 'reaction');
            
            // 更新body类
            body.classList.toggle('cps-mode', mode === 'cps');
            body.classList.toggle('reaction-mode', mode === 'reaction');
            
            // 更新按钮显示
            startCPSButton.style.display = mode === 'cps' ? 'inline-block' : 'none';
            startReactionButton.style.display = mode === 'reaction' ? 'inline-block' : 'none';
            
            // 更新说明和UI显示
            if (mode === 'cps') {
                counter.textContent = 'CPS 对战模式';
                instruction.textContent = '点击更快以扩大你的区域';
                cpsDisplay.style.opacity = '1';
                gameTime.style.opacity = '1';
                reactionTimeDisplay.style.opacity = '0';
                blueBall.style.display = 'none';
                redBall.style.display = 'none';
            } else {
                counter.textContent = '反应力对战模式';
                instruction.textContent = '等待屏幕变绿后立即点击';
                cpsDisplay.style.opacity = '0';
                gameTime.style.opacity = '0';
                reactionTimeDisplay.style.opacity = '1';
                blueBall.style.display = 'block';
                redBall.style.display = 'block';
            }
        }

        // 开始CPS游戏
        function startCPSGame() {
            disableStartButtons();
            gameState.countingDown = true;
            counter.textContent = gameState.countdown;
            counter.classList.add('countdown');
            
            // 播放滴答声
            playSound(tickSound);

            gameState.countdownInterval = setInterval(() => {
                gameState.countdown--;
                if (gameState.countdown > 0) {
                    counter.textContent = gameState.countdown;
                    counter.classList.remove('countdown');
                    // 触发重排以重新应用动画
                    void counter.offsetWidth;
                    counter.classList.add('countdown');
                    // 播放滴答声
                    playSound(tickSound);
                } else if (gameState.countdown === 0) {
                    counter.textContent = 'Go!';
                    counter.classList.remove('countdown');
                    // 触发重排以重新应用动画
                    void counter.offsetWidth;
                    counter.classList.add('countdown');
                    // 播放Go声音
                    playSound(goSound);
                } else {
                    clearInterval(gameState.countdownInterval);
                    gameState.countingDown = false;
                    gameState.started = true;
                    gameState.gameStartTime = performance.now();
                    counter.textContent = '';
                    counter.classList.remove('countdown');
                    instruction.textContent = '疯狂点击吧！';
                    
                    // 开始计算游戏时间
                    startGameTimeCounter();
                    // 开始计算CPS
                    updateCPS();
                }
            }, 1000);
        }

        // 开始反应游戏
        function startReactionGame() {
            disableStartButtons();
            gameState.started = true;
            counter.textContent = '等待变绿...';
            instruction.textContent = '不要提前点击！';
            
            // 重置小球状态
            blueBall.classList.remove('green');
            redBall.classList.remove('green');
            
            // 设置随机等待时间（2-6秒）
            gameState.reactionWaitTime = Math.random() * 4000 + 2000;
            
            // 播放等待音效（低频滴答声）
            gameState.waitingSoundInterval = setInterval(() => {
                playSound(waitingSound);
            }, 500);
            
            gameState.reactionTimer = setTimeout(() => {
                if (gameState.started && !gameState.falseStart) {
                    // 清除等待音效
                    clearInterval(gameState.waitingSoundInterval);
                    
                    // 变绿
                    blueBall.classList.add('green');
                    redBall.classList.add('green');
                    counter.textContent = 'GREEN! Press!';
                    instruction.textContent = '立即点击你的按键！';
                    gameState.greenTime = performance.now();
                    
                    // 播放变绿提示音
                    playSound(greenSound);
                }
            }, gameState.reactionWaitTime);
        }

        // 禁用开始按钮
        function disableStartButtons() {
            startCPSButton.disabled = true;
            startReactionButton.disabled = true;
        }

        // 启用开始按钮
        function enableStartButtons() {
            startCPSButton.disabled = false;
            startReactionButton.disabled = false;
        }

        // 更新游戏状态（CPS模式）
        function updateGameState() {
            if (gameState.mode === 'cps' && gameState.started) {
                const difference = gameState.blueScore - gameState.redScore;
                const maxDifference = 30;
                
                // 计算宽度百分比
                let blueWidth = 50 + (difference / maxDifference) * 50;
                let redWidth = 50 - (difference / maxDifference) * 50;
                
                // 限制在合理范围内
                blueWidth = Math.max(0, Math.min(100, blueWidth));
                redWidth = Math.max(0, Math.min(100, redWidth));
                
                // 更新DOM
                blueArea.style.width = `${blueWidth}%`;
                redArea.style.width = `${redWidth}%`;
                divider.style.left = `${blueWidth}%`;
                
                blueScoreEl.textContent = `蓝方: ${gameState.blueScore}`;
                redScoreEl.textContent = `红方: ${gameState.redScore}`;
                
                // 检查胜负条件
                if (Math.abs(difference) >= maxDifference) {
                    endGame(difference > 0 ? 'blue' : 'red');
                }
            }
        }

        // 更新CPS
        function updateCPS() {
            if (gameState.started && gameState.mode === 'cps') {
                const elapsedTime = (performance.now() - gameState.gameStartTime) / 1000;
                const blueCpsValue = elapsedTime > 0 ? (gameState.blueScore / elapsedTime).toFixed(2) : '0.00';
                const redCpsValue = elapsedTime > 0 ? (gameState.redScore / elapsedTime).toFixed(2) : '0.00';
                
                blueCPS.textContent = `蓝方 CPS: ${blueCpsValue}`;
                redCPS.textContent = `红方 CPS: ${redCpsValue}`;
                
                if (gameState.started) {
                    requestAnimationFrame(updateCPS);
                }
            }
        }

        // 开始游戏时间计数器
        function startGameTimeCounter() {
            gameState.gameTimeInterval = setInterval(() => {
                if (gameState.started) {
                    const elapsedTime = (performance.now() - gameState.gameStartTime) / 1000;
                    gameTime.textContent = `游戏时间: ${elapsedTime.toFixed(2)}s`;
                }
            }, 100);
        }

        // 结束游戏函数
        function endGame(winner) {
            // 清除所有定时器
            clearInterval(gameState.countdownInterval);
            clearInterval(gameState.gameTimeInterval);
            clearInterval(gameState.waitingSoundInterval);
            clearTimeout(gameState.reactionTimer);
            
            gameState.started = false;
            gameState.gameEndTime = performance.now();
            gameState.currentWinner = winner;
            
            let winnerText;
            let loser;
            
            if (winner === 'blue') {
                winnerText = 'Blue Wins!';
                loser = 'red';
                // 添加闪烁效果
                blueArea.classList.add('blue-flash');
            } else {
                winnerText = 'Red Wins!';
                loser = 'blue';
                // 添加闪烁效果
                redArea.classList.add('red-flash');
            }
            
            // 显示胜利者
            winnerDisplay.textContent = winnerText;
            winnerDisplay.style.display = 'block';
            
            // 显示最终统计
            showFinalStats();
            
            // 播放胜利音效
            playSound(victorySound);
            
            // 显示彩带效果
            createConfetti(winner);
            
            // 启用重新开始按钮
            setTimeout(() => {
                enableStartButtons();
            }, 2000);
        }

        // 显示最终统计信息
        function showFinalStats() {
            let statsHTML = '';
            
            if (gameState.mode === 'cps') {
                const gameTime = (gameState.gameEndTime - gameState.gameStartTime) / 1000;
                const finalBlueCps = (gameState.blueScore / gameTime).toFixed(2);
                const finalRedCps = (gameState.redScore / gameTime).toFixed(2);
                
                statsHTML = `
                    <div>游戏持续时间: ${gameTime.toFixed(2)} 秒</div>
                    <div>蓝方点击: ${gameState.blueScore} 次 (CPS: ${finalBlueCps})</div>
                    <div>红方点击: ${gameState.redScore} 次 (CPS: ${finalRedCps})</div>
                `;
            } else {
                // 反应模式显示
                if (gameState.falseStart) {
                    statsHTML = `
                        <div>${gameState.falseStartPlayer === 'blue' ? '蓝方' : '红方'} 提前点击！</div>
                        <div>另一方获胜！</div>
                    `;
                } else {
                    const winner = gameState.currentWinner;
                    const winnerTime = winner === 'blue' ? gameState.blueReactionTime : gameState.redReactionTime;
                    const loserTime = winner === 'blue' ? gameState.redReactionTime : gameState.blueReactionTime;
                    
                    statsHTML = `
                        <div>${winner === 'blue' ? 'Blue' : 'Red'} wins in ${winnerTime} ms</div>
                        <div>蓝方反应时间: ${gameState.blueReactionTime || '--'} ms</div>
                        <div>红方反应时间: ${gameState.redReactionTime || '--'} ms</div>
                    `;
                }
            }
            
            finalStats.innerHTML = statsHTML;
            finalStats.style.opacity = '1';
        }

        // 检测提前点击
        function detectFalseStart(player) {
            if (gameState.mode === 'reaction' && gameState.started && !gameState.falseStart && !gameState.greenTime) {
                // 清除等待音效和定时器
                clearInterval(gameState.waitingSoundInterval);
                clearTimeout(gameState.reactionTimer);
                
                gameState.falseStart = true;
                gameState.falseStartPlayer = player;
                
                // 播放错误音效
                playSound(buzzSound);
                
                // 显示错误信息
                counter.textContent = 'False Start!';
                instruction.textContent = '提前点击了！';
                
                // 结束游戏，另一方获胜
                const winner = player === 'blue' ? 'red' : 'blue';
                setTimeout(() => {
                    endGame(winner);
                }, 1000);
            }
        }

        // 创建彩带效果
        function createConfetti(winner) {
            const colors = winner === 'blue' 
                ? ['#3498db', '#2980b9', '#5dade2'] 
                : ['#e74c3c', '#c0392b', '#ec7063'];
            
            for (let i = 0; i < 200; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-20px';
                confetti.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
                confetti.style.opacity = Math.random() * 0.8 + 0.2;
                confetti.style.animation = 'falling ' + (Math.random() * 3 + 2) + 's linear forwards';
                
                document.head.insertAdjacentHTML('beforeend', `
                    <style>
                        @keyframes falling {
                            0% { transform: translateY(-20px) rotate(${Math.random() * 360}deg); }
                            100% { 
                                transform: translateY(${window.innerHeight + 20}px) rotate(${Math.random() * 720}deg); 
                                opacity: 0;
                            }
                        }
                    </style>
                `);
                
                confettiContainer.appendChild(confetti);
                
                // 移除彩带元素
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        // 创建波纹效果
        function createRipple(x, y, player) {
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            
            if (player === 'blue') {
                blueArea.appendChild(ripple);
            } else {
                redArea.appendChild(ripple);
            }
            
            // 移除波纹元素
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // 播放音效（使用模拟音效）
        function playSound(audioElement) {
            // 在实际环境中，这里会播放真实的音效
            // 由于我们没有实际的音频文件，这里只是一个占位符
            console.log('播放音效:', audioElement.id);
        }

        // 重置游戏
        function resetGame() {
            // 清除所有定时器
            clearInterval(gameState.countdownInterval);
            clearInterval(gameState.gameTimeInterval);
            clearInterval(gameState.waitingSoundInterval);
            clearTimeout(gameState.reactionTimer);
            
            // 重置游戏状态
            gameState.started = false;
            gameState.countingDown = false;
            gameState.blueScore = 0;
            gameState.redScore = 0;
            gameState.bluePressed = false;
            gameState.redPressed = false;
            gameState.countdown = 3;
            gameState.gameStartTime = 0;
            gameState.gameEndTime = 0;
            gameState.reactionWaitTime = 0;
            gameState.greenTime = 0;
            gameState.blueReactionTime = 0;
            gameState.redReactionTime = 0;
            gameState.falseStart = false;
            gameState.falseStartPlayer = null;
            gameState.currentWinner = null;
            
            // 重置UI
            winnerDisplay.style.display = 'none';
            finalStats.style.opacity = '0';
            blueArea.style.width = '50%';
            redArea.style.width = '50%';
            divider.style.left = '50%';
            blueScoreEl.textContent = '蓝方: 0';
            redScoreEl.textContent = '红方: 0';
            blueCPS.textContent = '蓝方 CPS: 0.00';
            redCPS.textContent = '红方 CPS: 0.00';
            gameTime.textContent = '游戏时间: 0.00s';
            blueReaction.textContent = '蓝方反应: -- ms';
            redReaction.textContent = '红方反应: -- ms';
            
            // 移除闪烁效果
            blueArea.classList.remove('blue-flash');
            redArea.classList.remove('red-flash');
            
            // 重置小球状态
            blueBall.classList.remove('green');
            redBall.classList.remove('green');
            
            // 清空彩带效果
            confettiContainer.innerHTML = '';
            
            // 启用按钮
            enableStartButtons();
            
            // 设置初始提示
            if (gameState.mode === 'cps') {
                counter.textContent = 'CPS 对战模式';
                instruction.textContent = '点击下方按钮开始游戏';
            } else {
                counter.textContent = '反应力对战模式';
                instruction.textContent = '点击下方按钮开始游戏';
            }
        }

        // 键盘事件监听
        document.addEventListener('keydown', (event) => {
            // 只有在游戏开始后且不在倒计时阶段才能操作
            if ((gameState.started || gameState.mode === 'reaction') && !gameState.countingDown) {
                // 蓝方按键
                if (event.key.toLowerCase() === 's') {
                    // 防作弊：只在keyup后才允许再次计数
                    if (!gameState.bluePressed) {
                        gameState.bluePressed = true;
                        
                        if (gameState.mode === 'cps' && gameState.started) {
                            gameState.blueScore++;
                            updateGameState();
                            
                            // 添加震动效果
                            blueArea.classList.add('vibrate');
                            setTimeout(() => {
                                blueArea.classList.remove('vibrate');
                            }, 100);
                            
                            // 创建波纹效果
                            const rect = blueArea.getBoundingClientRect();
                            createRipple(rect.width / 2, rect.height / 2, 'blue');
                            
                            // 播放点击音效
                            playSound(clickBlue);
                        } else if (gameState.mode === 'reaction') {
                            // 检查是否是提前点击
                            if (!gameState.greenTime) {
                                detectFalseStart('blue');
                            } else if (!gameState.blueReactionTime && !gameState.falseStart) {
                                // 记录反应时间
                                gameState.blueReactionTime = Math.round(performance.now() - gameState.greenTime);
                                blueReaction.textContent = `蓝方反应: ${gameState.blueReactionTime} ms`;
                                
                                // 添加震动效果
                                blueArea.classList.add('vibrate');
                                setTimeout(() => {
                                    blueArea.classList.remove('vibrate');
                                }, 100);
                                
                                // 播放点击音效
                                playSound(clickBlue);
                                
                                // 检查是否双方都已点击
                                if (gameState.redReactionTime) {
                                    // 判定胜负
                                    const winner = gameState.blueReactionTime < gameState.redReactionTime ? 'blue' : 'red';
                                    setTimeout(() => {
                                        endGame(winner);
                                    }, 500);
                                }
                            }
                        }
                    }
                }
                // 红方按键
                else if (event.key.toLowerCase() === 'l') {
                    // 防作弊：只在keyup后才允许再次计数
                    if (!gameState.redPressed) {
                        gameState.redPressed = true;
                        
                        if (gameState.mode === 'cps' && gameState.started) {
                            gameState.redScore++;
                            updateGameState();
                            
                            // 添加震动效果
                            redArea.classList.add('vibrate');
                            setTimeout(() => {
                                redArea.classList.remove('vibrate');
                            }, 100);
                            
                            // 创建波纹效果
                            const rect = redArea.getBoundingClientRect();
                            createRipple(rect.width / 2, rect.height / 2, 'red');
                            
                            // 播放点击音效
                            playSound(clickRed);
                        } else if (gameState.mode === 'reaction') {
                            // 检查是否是提前点击
                            if (!gameState.greenTime) {
                                detectFalseStart('red');
                            } else if (!gameState.redReactionTime && !gameState.falseStart) {
                                // 记录反应时间
                                gameState.redReactionTime = Math.round(performance.now() - gameState.greenTime);
                                redReaction.textContent = `红方反应: ${gameState.redReactionTime} ms`;
                                
                                // 添加震动效果
                                redArea.classList.add('vibrate');
                                setTimeout(() => {
                                    redArea.classList.remove('vibrate');
                                }, 100);
                                
                                // 播放点击音效
                                playSound(clickRed);
                                
                                // 检查是否双方都已点击
                                if (gameState.blueReactionTime) {
                                    // 判定胜负
                                    const winner = gameState.blueReactionTime < gameState.redReactionTime ? 'blue' : 'red';
                                    setTimeout(() => {
                                        endGame(winner);
                                    }, 500);
                                }
                            }
                        }
                    }
                }
            }
        });

        // 键盘抬起事件监听
        document.addEventListener('keyup', (event) => {
            if (event.key.toLowerCase() === 's') {
                gameState.bluePressed = false;
            } else if (event.key.toLowerCase() === 'l') {
                gameState.redPressed = false;
            }
        });

        // 事件监听器
        startCPSButton.addEventListener('click', () => {
            if (gameState.mode !== 'cps') {
                switchMode('cps');
            }
            resetGame();
            startCPSGame();
        });

        startReactionButton.addEventListener('click', () => {
            if (gameState.mode !== 'reaction') {
                switchMode('reaction');
            }
            resetGame();
            startReactionGame();
        });

        cpsModeButton.addEventListener('click', () => {
            switchMode('cps');
        });

        reactionModeButton.addEventListener('click', () => {
            switchMode('reaction');
        });

        // 初始化游戏状态
        switchMode('cps');
    </script>
</body>
</html>